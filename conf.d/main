#!/bin/sh -ex

apt-get -y update
apt-get -y dist-upgrade
apt-get -y install jellyfin

# Rename the file server for WebDAVCGI
CONF=/var/www/webdavcgi/webdav.conf
sed -i "s|FILESERVER|MEDIASERVER|" $CONF

# Rename the samba service
CONF=/etc/samba/smb.conf
sed -i "s|FILESERVER|MEDIASERVER|" $CONF
sed -i "s|FileServer|MediaServer|" $CONF

# Change default group to users
usermod -g users jellyfin

# Setup default media directories
for fn in Music Movies TVShows Photos; do
    mkdir -p /srv/storage/$fn
    chown jellyfin:users /srv/storage/$fn
    chmod g+w /srv/storage/$fn
done

# Apache config for WebDavCGI
a2dissite 000-default.conf
a2ensite webdavcgi.conf
a2ensite tkl-webcp.conf

# Apache config for reverse proxy
echo 'Listen 12322' >> /etc/apache2/ports.conf
a2ensite jellyfin-proxy.conf
a2enmod headers
a2enmod proxy_http
a2enmod proxy_wstunnel

# Perform initial setup
python /usr/local/src/jellyfin-setup.py
